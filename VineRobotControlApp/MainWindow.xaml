<Window x:Class="VineRobotControlApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:VineRobotControlApp"
        xmlns:models="clr-namespace:VineRobotControlApp.Models"
        xmlns:ScottPlot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
        mc:Ignorable="d"
        Title="Vine Robot Control" Height="720" Width="1200"
        MinWidth="960" MinHeight="640">
    <Window.Resources>
        <local:SelectedBrushConverter x:Key="SelectedBrushConverter" />
        <Style TargetType="TextBlock" x:Key="HeaderText">
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="FontSize" Value="14" />
        </Style>
        <Style TargetType="Button" x:Key="TransparentButton">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
        </Style>
        <DataTemplate DataType="{x:Type models:SegmentSetpoint}">
            <Button Tag="{Binding}" Click="SelectSetpoint_Click" Padding="6" Margin="0,4" HorizontalAlignment="Stretch" Style="{StaticResource TransparentButton}">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Ellipse Width="24" Height="24" Margin="0,0,8,0"
                             Fill="{Binding IsSelected, Converter={StaticResource SelectedBrushConverter}}"
                             Stroke="Gray" StrokeThickness="1" />
                    <TextBlock Text="{Binding DisplayName}" />
                </StackPanel>
            </Button>
        </DataTemplate>
    </Window.Resources>
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="160" />
        </Grid.RowDefinitions>
        <Border Grid.Row="0" Padding="12" Background="#f3f4f6" CornerRadius="6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3*" />
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="2*" />
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Serial Port:" VerticalAlignment="Center" Style="{StaticResource HeaderText}" />
                    <ComboBox x:Name="PortCombo" Width="160" IsEditable="False" />
                    <Button Content="Refresh" Click="RefreshPorts_Click" />
                    <Button x:Name="ConnectButton" Content="Connect" Width="100" Click="ConnectButton_Click" />
                    <TextBlock Text="Baud:" VerticalAlignment="Center" Margin="16,0,0,0" />
                    <TextBox x:Name="BaudText" Width="80" Text="115200" />
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                    <TextBlock Text="Selected:" VerticalAlignment="Center" Style="{StaticResource HeaderText}" />
                    <ComboBox Width="180" ItemsSource="{Binding Setpoints}" SelectedItem="{Binding SelectedSetpoint}" DisplayMemberPath="DisplayName" />
                    <Button Content="Send Selected" Click="SendSelected_Click" />
                    <Button Content="Send All" Click="SendAll_Click" />
                </StackPanel>
                <StackPanel Grid.Column="2" HorizontalAlignment="Right">
                    <TextBlock Text="{Binding StatusMessage}" HorizontalAlignment="Right" />
                    <ProgressBar x:Name="ConnectionProgress" Height="6" Margin="0,6,0,0" Minimum="0" Maximum="1" Value="0" />
                </StackPanel>
            </Grid>
        </Border>
        <TabControl Grid.Row="1" Margin="0,12,0,12">
            <TabItem Header="Setpoints">
                <Grid Margin="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <DataGrid x:Name="SetpointGrid" Grid.Row="0" Grid.Column="0" ItemsSource="{Binding Setpoints}"
                              AutoGenerateColumns="False" CanUserAddRows="False" Margin="0,0,12,0"
                              CellEditEnding="SetpointGrid_CellEditEnding" HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Side" Binding="{Binding Side}" IsReadOnly="True" />
                            <DataGridTextColumn Header="Segment" Binding="{Binding Segment}" IsReadOnly="True" />
                            <DataGridTextColumn Header="Setpoint (PSI)" Binding="{Binding Psi, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            <DataGridTextColumn Header="Expected ADC" Binding="{Binding ExpectedAdc}" IsReadOnly="True" />
                            <DataGridTemplateColumn Header="Send">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Send" Padding="8,2" Tag="{Binding}" Click="SendSetpoint_Click" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                    <Border Grid.Row="0" Grid.Column="1" Padding="12" Background="#f9fafb" CornerRadius="8">
                        <StackPanel>
                            <TextBlock Text="Series Pouch End View" Style="{StaticResource HeaderText}" />
                            <Grid Margin="0,12,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition />
                                    <ColumnDefinition />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <TextBlock Text="Left" Grid.Row="0" Grid.Column="0" HorizontalAlignment="Center" />
                                <TextBlock Text="Right" Grid.Row="0" Grid.Column="1" HorizontalAlignment="Center" />
                                <ItemsControl Grid.Row="1" Grid.Column="0" ItemsSource="{Binding Setpoints}" Margin="12,4" >
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style TargetType="ContentPresenter">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Side}" Value="Left">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>
                                <ItemsControl Grid.Row="1" Grid.Column="1" ItemsSource="{Binding Setpoints}" Margin="12,4">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style TargetType="ContentPresenter">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Side}" Value="Right">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>
                                <TextBlock Grid.Row="2" Grid.ColumnSpan="2" TextWrapping="Wrap"
                                           Text="Select a segment above to highlight which pouch the next command will control." />
                            </Grid>
                            <Separator Margin="0,12" />
                            <TextBlock Text="Calibration" Style="{StaticResource HeaderText}" />
                            <Grid Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <TextBlock Text="Left Psi Min:" Grid.Row="0" Grid.Column="0" />
                                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding LeftCalibration.PsiMin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Right Psi Min:" Grid.Row="0" Grid.Column="2" />
                                <TextBox Grid.Row="0" Grid.Column="3" Text="{Binding RightCalibration.PsiMin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Left Psi Max:" Grid.Row="1" Grid.Column="0" />
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding LeftCalibration.PsiMax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Right Psi Max:" Grid.Row="1" Grid.Column="2" />
                                <TextBox Grid.Row="1" Grid.Column="3" Text="{Binding RightCalibration.PsiMax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Left ADC Min:" Grid.Row="2" Grid.Column="0" />
                                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding LeftCalibration.AdcMin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Right ADC Min:" Grid.Row="2" Grid.Column="2" />
                                <TextBox Grid.Row="2" Grid.Column="3" Text="{Binding RightCalibration.AdcMin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Left ADC Max:" Grid.Row="3" Grid.Column="0" />
                                <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding LeftCalibration.AdcMax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBlock Text="Right ADC Max:" Grid.Row="3" Grid.Column="2" />
                                <TextBox Grid.Row="3" Grid.Column="3" Text="{Binding RightCalibration.AdcMax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            </Grid>
                        </StackPanel>
                    </Border>
                    <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                               Text="Use the calibration inputs to match each pressure sensor's ADC range. Setpoints are transmitted as PSI and the ESP32 firmware will map them back to ADC values." />
                </Grid>
            </TabItem>
            <TabItem Header="Monitoring">
                <Grid Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="3*" />
                        <RowDefinition Height="2*" />
                    </Grid.RowDefinitions>
                    <ScottPlot:WpfPlot x:Name="PressurePlot" Grid.Row="0" Margin="0,0,0,12" />
                    <DataGrid Grid.Row="1" ItemsSource="{Binding Telemetry}" AutoGenerateColumns="False" CanUserAddRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Time" Binding="{Binding Timestamp}" />
                            <DataGridTextColumn Header="Side" Binding="{Binding Side}" />
                            <DataGridTextColumn Header="Segment" Binding="{Binding Segment}" />
                            <DataGridTextColumn Header="PSI (raw)" Binding="{Binding PsiRaw, StringFormat=F2}" />
                            <DataGridTextColumn Header="PSI (filtered)" Binding="{Binding PsiFiltered, StringFormat=F2}" />
                            <DataGridTextColumn Header="ADC" Binding="{Binding Adc}" />
                            <DataGridCheckBoxColumn Header="Outlier" Binding="{Binding IsOutlier}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>
        <Border Grid.Row="2" Padding="8" Background="#111827" CornerRadius="6">
            <StackPanel>
                <TextBlock Text="Serial Log" Foreground="White" FontWeight="Bold" />
                <ListBox ItemsSource="{Binding SerialLogs}" Foreground="White" Background="#1f2937" />
            </StackPanel>
        </Border>
    </Grid>
</Window>
